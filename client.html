<!DOCTYPE html>
<html>

<head>
    <title>Webcam Stream and Chat</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
            font-family: 'Arial', sans-serif;
        }

        #videoElement {
            width: 480px;
            height: 360px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        #chat {
            display: flex;
            flex-direction: column;
            width: 480px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #fff;
        }

        #chatWindow {
            height: 200px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow-y: scroll;
        }

        #chatInput {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        #sendButton {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #0078d4;
            color: #fff;
            cursor: pointer;
        }

        #sendButton:hover {
            background-color: #005a9e;
        }

        #login {
            display: flex;
            flex-direction: column;
            width: 480px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #fff;
            margin-bottom: 20px;
        }

        #login input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        #login button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #0078d4;
            color: #fff;
            cursor: pointer;
        }

        #login button:hover {
            background-color: #005a9e;
        }
    </style>
</head>

<body>
    <h1>Webcam Stream and Chat</h1>
    <div id="login">
        <input type="text" id="nicknameInput" placeholder="Nickname">
        <input type="password" id="passwordInput" placeholder="Password">
        <button id="loginButton">Login</button>
    </div>
    <div id="app" style="display: none;">
        <video autoplay="true" id="videoElement"></video>
        <div id="chat">
            <textarea id="chatWindow" readonly></textarea>
            <input type="text" id="chatInput">
            <button id="sendButton">Send</button>
        </div>
    </div>
    <script>
        var video = document.querySelector("#videoElement");
        var chatWindow = document.querySelector("#chatWindow");
        var chatInput = document.querySelector("#chatInput");
        var sendButton = document.querySelector("#sendButton");
        var loginButton = document.querySelector("#loginButton");
        var nicknameInput = document.querySelector("#nicknameInput");
        var passwordInput = document.querySelector("#passwordInput");
        var app = document.querySelector("#app");

        var ws = null;
        function connect() {
            ws = new WebSocket('ws://localhost:8765');
            ws.onclose = function (event) {
                ws = null;
                setTimeout(function () {
                    connect();
                }, 5000);
            }
            ws.onmessage = function (event) {
                var data = JSON.parse(event.data);
                if (data.type === 'chat') {
                    chatWindow.value += data.message + '\n';
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                } else if (data.type === 'login') {
                    if (data.success) {
                        document.getElementById('login').style.display = 'none';
                        app.style.display = 'block';
                    } else {
                        alert('Login failed. Please try again.');
                    }
                } else if (data.type === 'stream') {
                    video.src = data.stream;
                }
            };
            ws.onerror = function (event) {
                console.log("Something went wrong!");
                console.log(event);
            };
        }
        connect();

        loginButton.onclick = function () {
            if (ws !== null) {
                ws.send(JSON.stringify({
                    type: 'login',
                    nickname: nicknameInput.value,
                    password: passwordInput.value
                }));
            }
        };

        sendButton.onclick = function () {
            if (ws !== null) {
                ws.send(JSON.stringify({
                    type: 'chat',
                    message: chatInput.value
                }));
                chatInput.value = '';
            }
        };

        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                    video.srcObject = stream;
                })
                .catch(function (error) {
                    console.log("Can't access webcam");
                    console.log(error);
                });
        }
    </script>
</body>

</html>